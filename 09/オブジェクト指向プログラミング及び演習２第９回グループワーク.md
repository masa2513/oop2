# オブジェクト指向プログラミング及び演習２　第９回グループワーク

**学籍番号・氏名：**　k24040 加藤雅士

**グループメンバー（学籍番号・氏名）：**

K24017 伊藤 源太
K24149 渡邉 晴美

# WebAPI設計ワークシート：学食モバイルオーダーを作ろう

スマホから学食のメニューを注文できるWebAPIを設計します。

「どんなデータ（リソース）」を、「どのURL」で、「どう操作（HTTPメソッド）」するかをチームで話し合って決定してください。

## ステップ1：扱う「リソース（モノ）」を決めよう

このシステムで管理・操作する必要があるデータ（名詞）を挙げてください。（例：Menu, Userなど）

- Menu（メニュー）
  - 

- Order（注文）

- OrderStatus（注文ステータス）

- Cart（買い物かご）

## ステップ2：APIエンドポイント一覧表を作ろう

クライアント（スマホアプリ）がサーバーに依頼する操作を定義しましょう。

ヒント: URLには「動詞」を含めず、HTTPメソッド（GET, POSTなど）で使い分けましょう。

| **No.** | **やりたいこと** | **HTTPメソッド** | **URL (例: /items)** | **説明** |
|----|----|----|----|----|
| 1 | メニューの一覧を見る | GET | /menus | 全てのメニュー情報を取得する |
| 2 | メニューの詳細を見る | GET | /menus/{itemId} | 特定のメニューの詳細情報を取得する |
| 3 | 買い物かごに追加する | POST | /menus/{itemId} | メニューで選択した情報を送る |
| 4 | 注文を確定する | POST | /cart | 買い物かごの内容を注文として確定する |
| 5 | 注文状況を確認する | GET | /status | 調理中、完了を見る |


## ステップ3：データのやり取り（JSON）を設計しよう

**例：  **
やりたいことに「注文をする」 機能を書いたとして、それついて、スマホから送るデータと、サーバーから返ってくるデータを具体的に書きましょう。

## 「メニュー一覧を表示する」

### Request（スマホからサーバーへ送るデータ）

パラメータなし（GETリクエストのみ）

### Response（サーバーからスマホへ返す結果）

全てのメニュー情報を配列で返す。

```
JSON

[
  {
    "menuId": 1,
    "name": "カレーライス",
    "price": 600,
    "picture": "https://example.com/picture1.jpg",
    "soldout": true
  },
  {
    "menuId": 2,
    "name": "ラーメン",
    "price": 550,
    "picture": "https://example.com/picture2.jpg",
    "soldout": false
  },
  {
    "menuId": 3,
    "name": "サラダ",
    "price": 300,
    "picture": "https://example.com/picture3.jpg",
    "soldout": true
  }
]
```

## 「メニューの詳細を表示する」

### Request（スマホからサーバーへ送るデータ）

パラメータなし（GETリクエストのみ）

### Response（サーバーからスマホへ返す結果）

特定のメニューの詳細情報を返す。

```
JSON

{
  "menuId": 1,
  "name": "カレーライス",
  "price": 600,
  "picture": "https://example.com/picture1.jpg",
  "soldOut": true
}
```

## 「買い物かごに追加する」

### Request（スマホからサーバーへ送るデータ）

どのメニューを、いくつ買い物かごに入れるか？

```
JSON

{
  "menuId": 1,
  "quantity": 2,
}
```

### Response（サーバーからスマホへ返す結果）

追加後の買い物かごの状態を返す。

```
JSON

{
  "message": "買い物かごに追加しました",
  "cart": [
    {
      "cartItemId": 1,
      "menuId": 1,
      "name": "カレーライス",
      "quantity": 2,
      "price": 600,
      "subTotal": 1200
    }
  ],
  "totalPrice": 1200,
  "itemCount": 2
}
```


## 「注文する」

### Request（スマホからサーバーへ送るデータ）

買い物かごの内容を注文として確定する。

```
JSON

{
  "userId": 1,
}
```

（または、買い物かごを使わず直接注文する場合）

```
JSON

{
  "items": [
    {
      "menuId": 1,
      "quantity": 2
    },
    {
      "menuId": 2,
      "quantity": 1
    }
  ],
  "userId": 1
}
```

### Response（サーバーからスマホへ返す結果）

注文が成功した証拠（注文番号など）や、待ち時間を返してあげよう。

```
JSON

{
  "message": "注文を受け付けました",
  "orderId": 12345,
  "orderStatus": "accepted",
  "totalPrice": 1200,
}
```

## 「注文状況を確認する」

### Request（スマホからサーバーへ送るデータ）

パラメータなし（GETリクエストのみ）

### Response（サーバーからスマホへ返す結果）

注文状況を返す。

```
JSON

{
  "message": "注文状況を確認しました",
  "orderStatus": "accepted",
}
```
## ステップ4：発展課題（時間が余ったら）

なし


### 【個人課題】振り返りと発展考察

<u>※ここからはグループではなく、**個人**で記入してください。</u>

## 1. 設計において工夫した点・こだわった点


1. **売り切れ状態の可視化**: メニュー一覧のレスポンスに`soldout`フィールドを含めることで、ユーザーが注文前に売り切れメニューを把握でき、無駄な注文操作を防ぐことができる。

2. **画像URLの提供**: メニュー情報に`picture`フィールドを含めることで、視覚的にメニューを選択しやすくし、ユーザーの意思決定を支援する。

3. **買い物かご機能の実装**: 複数のメニューを一度に注文できる買い物かご機能を実装することで、ユーザーが複数のメニューを選んでからまとめて注文でき、操作の手間を削減する。

4. **注文状況の確認機能**: `GET /status`エンドポイントを提供することで、ユーザーが調理状況をリアルタイムで確認でき、適切なタイミングで窓口へ向かうことができる。

5. **JSONフィールド名の統一**: キャメルケース（`menuId`, `totalPrice`, `orderStatus`など）で統一することで、フロントエンドとの連携がしやすく、コードの可読性が向上する。



## 2. 追加調査・学習（Web APIの技術背景）

今回の演習中に疑問に思ったこと、または演習を通して新しく調べて知った用語や概念について記述してください。1つだけでなく、複数書きましょう。 （例：HTTPステータスコード 418 とは何か、REST以外のAPI設計にはどんなものがあるか、など）

**調べたキーワード:** HTTPステータスコード 409 Conflict

**内容:**
409 Conflictは、リクエストが現在のリソースの状態と競合する場合に使用されるステータスコードです。。これは、リクエスト自体は正しい形式だが、現在のシステム状態（在庫数）と競合しているためです。400 Bad Requestとは異なり、409は「リソースの状態が原因で処理できない」ことを明確に示すことができます。

**調べたキーワード:** RESTful API設計原則

**内容:**
RESTful APIでは、URLに動詞を含めず、リソース（名詞）を表現し、HTTPメソッド（GET, POST, PUT, DELETEなど）で操作を表現することが原則です。今回の設計では、`/menus`や`/orders`のようにリソース名のみを使用し、`GET /menus`で取得、`POST /orders`で作成するように設計しました。また、リソースの階層構造も意識し、`/menus/{itemId}`のように特定のリソースを指定できるようにしました。

**調べたキーワード:** JSON命名規則（キャメルケース vs スネークケース）

**内容:**
JSONのフィールド名には、キャメルケース（`menuId`, `totalPrice`）とスネークケース（`menu_id`, `total_price`）の2つの命名規則があります。JavaScriptやTypeScriptなどのフロントエンド言語ではキャメルケースが一般的で、PythonやRubyなどのバックエンド言語ではスネークケースが一般的です。API設計では、一貫性を保つことが重要で、プロジェクト全体で統一することが推奨されます。



## 3. 発展課題: 設計の妥当性と課題

### Q1. エッジケース（異常系）への対応

今回のグループワークでは時間の都合で省略した部分もあると思います。もしこのシステムを**<u>「実際に学食で運用する」</u>**としたら、どのようなトラブル（異常な操作や通信エラー）が想定されますか？また、それをAPI側でどう防ぐべきですか？

**想定されるトラブル1:** 同時に最後の1食が注文された場合

**解決策のアイデア:** 注文確定前に在庫を再確認し、トランザクション処理（データベースのロック機能）を使用して在庫を確保する。在庫が不足している場合は409 Conflictエラーを返し、エラーメッセージで「在庫が不足しています」と明確に伝える。また、楽観的ロックを使用して、在庫更新時のバージョン番号をチェックすることで、同時注文による競合を防ぐ。

**想定されるトラブル2:** ネットワークエラーによる注文の重複送信

**解決策のアイデア:** 冪等性を保証するため、注文リクエストに一意のトークン（`idempotency_key`）を含める。同じトークンで複数回リクエストが来た場合、最初のリクエストの結果を返し、重複した注文を作成しないようにする。また、注文確定後は即座に`orderId`を返し、クライアント側で重複送信を防ぐ仕組みを実装する。

**想定されるトラブル3:** 長時間放置された買い物かごの処理

**解決策のアイデア:** 買い物かごに有効期限を設け、期限切れの買い物かごは自動的にクリアする。また、注文確定時に買い物かごの最終更新時刻をチェックし、一定時間以上経過している場合は警告メッセージを返す。これにより、在庫が確保されたまま注文が確定されない状況を防ぐ。


### Q2. 既存サービスとの比較（リサーチ課題）

Uber Eats、X (Twitter)、Google Mapsなど、世の中に公開されているWeb APIを1つ調べ、今回の自分たちの設計と比較して「真似したい点」**や**「違い」を書いてください。 （ヒント: "Uber Eats API documentation" などで検索してみよう）

**調べたサービス:** X (Twitter) API v2

**発見したこと:**

X (Twitter) API v2を調査した結果、以下のような設計パターンや特徴を発見しました。

**真似したい点:**

1. **RESTfulなリソース設計**: Twitter APIでは、`GET /2/tweets`、`POST /2/tweets`のように、リソース（tweets）に対してHTTPメソッドで操作を表現する明確な設計がされています。

2. **フィールド選択機能**: Twitter APIでは、`tweet.fields`や`user.fields`パラメータを使用して、必要なフィールドのみを取得できる機能があります。

3. **レート制限の明確な仕様**: Twitter APIでは、各エンドポイントごとにレート制限（1時間あたりのリクエスト数）が明確に定義されており、レスポンスヘッダーで現在の残り回数を返します。

4. **エラーレスポンスの構造化**: Twitter APIでは、エラー発生時に`{"errors": [{"code": 404, "message": "Not Found"}]}`のような構造化されたエラーレスポンスを返します。

5. **拡張可能なメタデータ**: Twitter APIでは、レスポンスに`meta`フィールドを含めて、ページネーション情報やリクエストIDなどのメタデータを返します。

**違い:**

1. **認証の複雑さ**: Twitter APIではOAuth 2.0やBearer Tokenによる認証が必須ですが、今回の設計では学習目的で認証を除外しました。実際の運用では認証が必要ですが、シンプルなAPI設計の理解には認証なしでも十分です。

2. **リソースの性質**: Twitter APIは主に「投稿の作成・取得」というCRUD操作が中心ですが、学食のモバイルオーダーシステムでは「注文の作成・ステータス確認」という、よりビジネスロジックが複雑な操作が中心です。そのため、ステータス管理や在庫管理などの追加的な考慮が必要です。

3. **リアルタイム性の要求**: Twitter APIではタイムラインの更新など、リアルタイム性が重要ですが、学食の注文システムでは数分単位の更新で十分です。ただし、調理完了の通知など、一部の機能ではリアルタイム性が有用です。

4. **データの永続性**: Twitter APIでは投稿データは永続的に保存されますが、学食のモバイルオーダーシステムでは、買い物かごのような一時的なデータも扱う必要があります。そのため、データの有効期限管理が重要になります。

### Q3. グループワークへの貢献と感想

チーム内での自分の役割（リーダー、アイデア出し、書記など）と、議論の中で自分が貢献できたと思う点について振り返ってください。

今回はリーダーを担当しました。議論の中で自分が貢献できたと思う点については、API設計のロジックと書記です。APIのロジックを自分の言葉で説明することで、他人に教える大切さを振り返ることができました。また、自分の考えを表すための方法も学びたいと思いました。例えば、シーケンス図を使って説明することで、他人に理解してもらうことができると思いました。
